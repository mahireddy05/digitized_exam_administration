{% extends "core/base_admin.html" %}
{% load static %}
{% block content %}
<div class="pages-main">
    <h1 class="pages-main-head">Student Course Registrations</h1>
    <div class="note-and-actions">
        <div class="note-text">
            <p style="color: red;"><strong>Note:</strong> Upload course registration data in <strong>.csv</strong> format.</p>
            <p style="color: red;">(Download the sample .csv file and add data in the specified structure to avoid errors)</p>
        </div>
        <div class="add-data">
            <form action="{% url 'masters:coursereg_upload' %}" method="post" enctype="multipart/form-data" style="display:inline;">
                {% csrf_token %}
                <label for="uploadFile" class="control-btn" style="cursor: pointer;">Upload File</label>
                <input type="file" id="uploadFile" name="csv_file" style="display: none;" accept=".csv" onchange="this.form.submit()">
            </form>
            <a href="{% static 'samples/student_reg_courses.csv' %}" download class="control-btn">Download Sample CSV</a>
        </div>
    </div>

    <div class="controls">
        <form id="filterForm" onsubmit="return false;">
            <label for="search">Search:</label>
            <input type="text" id="search" name="search" placeholder="Student ID, Course Code, or Name">

            <label for="filterCourse">Course:</label>
            <select id="filterCourse">
                <option value="">All Courses</option>
                {% for course in courses %}
                <option value="{{ course.course_code }}">{{ course.course_code }} - {{ course.course_name }}</option>
                {% endfor %}
            </select>

            <label for="filterYear">Academic Year:</label>
            <select id="filterYear">
                <option value="">All Years</option>
                {% for year in academic_years %}
                <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
            </select>

            <label for="filterSem">Semester:</label>
            <select id="filterSem">
                <option value="">All Semesters</option>
                {% for sem in semesters %}
                <option value="{{ sem }}">{{ sem }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <div class="actions" style="display: flex; align-items: center; gap: 16px;">
        <div class="pagination-bar" style="flex:1;" id="courseregPaginationBar">
            <div id="coursereg-pagination"></div>
        </div>
        <button type="button" id="resetCourseRegFilters"><img src="https://img.icons8.com/?size=100&id=12494&format=png&color=ffffff" alt="Reset_img">Reset</button>
        <button type="button" id="printCourseRegBtn"><img src="https://img.icons8.com/?size=100&id=85372&format=png&color=ffffff" alt="Print_img">Print</button>
        <button type="button" id="downloadCourseRegBtn"><img src="https://img.icons8.com/?size=100&id=83159&format=png&color=ffffff" alt="Download_img">Download Data</button>
    </div>

    <div class="table">
        <table id="coursereg-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Course Code</th>
                    <th>Course Name</th>
                    <th>Academic Year</th>
                    <th>Semester</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="coursereg-list">
                {# Table body will be filled by AJAX #}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit/Delete Modals for Course Registration (to be implemented in JS) -->
<div id="courseregEditModal" class="modal" style="display:none;"></div>
<div id="courseregDeleteModal" class="modal" style="display:none;"></div>
<script src="{% static 'js/scripts.js' %}"></script>
<script>
// --- AJAX Filtering, Pagination, Reset, Print, Download for Course Registrations ---
function loadCourseRegData(page=1) {
    const search = document.getElementById('search').value.trim();
    const course = document.getElementById('filterCourse').value;
    const year = document.getElementById('filterYear').value;
    const semester = document.getElementById('filterSem').value;
    const params = new URLSearchParams({
        type: 'coursereg',
        page: page,
        search: search,
        course: course,
        year: year,
        semester: semester
    });
    fetch(`/masters/ajax/?${params.toString()}`)
        .then(resp => resp.json())
        .then(data => {
            document.getElementById('coursereg-list').innerHTML = data.table_html;
            document.getElementById('coursereg-pagination').innerHTML = data.pagination_html;
        });
}

// Event listeners for filters
['search', 'filterCourse', 'filterYear', 'filterSem'].forEach(id => {
    document.getElementById(id).addEventListener('input', () => loadCourseRegData(1));
});

// Pagination click
document.getElementById('coursereg-pagination').addEventListener('click', function(e) {
    if (e.target.classList.contains('page-num') || e.target.classList.contains('page-arrow')) {
        e.preventDefault();
        const page = e.target.getAttribute('data-page');
        if (page) loadCourseRegData(page);
    }
});

// Reset button
document.getElementById('resetCourseRegFilters').addEventListener('click', function() {
    document.getElementById('search').value = '';
    document.getElementById('filterCourse').value = '';
    document.getElementById('filterYear').value = '';
    document.getElementById('filterSem').value = '';
    loadCourseRegData(1);
});

// Print button
document.getElementById('printCourseRegBtn').addEventListener('click', function() {
    const table = document.getElementById('coursereg-table').outerHTML;
    const win = window.open('', '', 'width=900,height=700');
    win.document.write('<html><head><title>Print Course Registrations</title>');
    win.document.write('<link rel="stylesheet" href="/static/css/style.css">');
    win.document.write('</head><body>');
    win.document.write(table);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
});

// Download button
document.getElementById('downloadCourseRegBtn').addEventListener('click', function() {
    let csv = 'Student ID,Student Name,Course Code,Course Name,Academic Year,Semester\n';
    document.querySelectorAll('#coursereg-list tr').forEach(row => {
        let cols = Array.from(row.querySelectorAll('td')).slice(1, 7).map(td => '"' + td.innerText.replace(/"/g, '""') + '"');
        if (cols.length) csv += cols.join(',') + '\n';
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'course_registrations.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadCourseRegData(1);
});
</script>
{% endblock %}